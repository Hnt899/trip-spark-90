# Интеграция МТС Exolve для SMS-авторизации

## Обзор

МТС Exolve — это облачная платформа для отправки SMS-сообщений. Мы используем REST API для отправки SMS с кодами подтверждения при регистрации и авторизации пользователей.

## Документация

- [SMS API Reference](https://docs.exolve.ru/docs/ru/api-reference/sms-api/)
- [Инструкции по отправке SMS](https://docs.exolve.ru/docs/ru/instructions/sending-sms/)
- [SMPP Protocol (для высоконагруженных систем)](https://docs.exolve.ru/docs/ru/api-reference/sms-smpp/)

## Что было сделано

1. ✅ Создана Edge Function `send-sms-exolve` для отправки SMS через МТС Exolve API
2. ✅ Обновлена логика регистрации/авторизации в `AuthContext.tsx`
3. ✅ Используется таблица `verification_codes` для хранения кодов подтверждения

## Настройка

### Шаг 1: Регистрация в МТС Exolve

1. Зарегистрируйтесь на платформе [МТС Exolve](https://exolve.ru/)
2. Создайте приложение в личном кабинете
3. Получите API-ключ для авторизации запросов

### Шаг 2: Настройка отправителя

У вас есть два варианта:

**Вариант 1: Использовать номер телефона (рекомендуется для начала)**
- Купите номер телефона в личном кабинете МТС Exolve
- Используйте этот номер в качестве отправителя
- Не требует согласования, работает сразу
- Установите секрет: `EXOLVE_SENDER=+79001234567` (ваш номер)

**Вариант 2: Альфа-имя (для продакшена)**
- Для отправки SMS от имени вашей компании можно согласовать альфа-имя
- Процесс согласования может занять **3–4 недели**
- Требуются подтверждающие документы на владение товарным знаком или доменным именем
- Подробнее: [Согласование альфа-имени](https://help.mts-link.ru/article/21276)
- Установите секрет: `EXOLVE_SENDER=ваше_альфа_имя`

**Примечание:** Если `EXOLVE_SENDER` не установлен, будет использован номер по умолчанию из настроек вашего аккаунта МТС Exolve.

### Шаг 3: Установка секретов в Supabase

Установите следующие секреты через Supabase CLI:

```bash
# API ключ МТС Exolve (обязательно)
npx supabase secrets set EXOLVE_API_KEY=ваш_api_ключ

# Номер телефона или альфа-имя отправителя (опционально)
# Если используете номер: EXOLVE_SENDER=+79001234567
# Если используете альфа-имя: EXOLVE_SENDER=ваше_альфа_имя
# Если не указан - будет использован номер по умолчанию из аккаунта
npx supabase secrets set EXOLVE_SENDER=+79001234567
```

**Где найти API ключ:**
1. Войдите в личный кабинет МТС Exolve
2. Перейдите в раздел "Ключи" или "API"
3. Создайте новый API-ключ или скопируйте существующий

**Где найти номер телефона или альфа-имя:**
1. В личном кабинете МТС Exolve
2. Для номера: раздел "Нумерация" → "Мои номера" (купите номер, если его нет)
3. Для альфа-имени: раздел "Сообщения" → "Альфа-имена" (согласуйте, если нужно)

### Шаг 4: Деплой Edge Function

```bash
npx supabase functions deploy send-sms-exolve
```

### Шаг 5: Создание таблицы verification_codes

Если таблица еще не создана, выполните SQL в Supabase Dashboard → SQL Editor:

```sql
-- Таблица для хранения кодов подтверждения
CREATE TABLE IF NOT EXISTS verification_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone TEXT NOT NULL,
  code TEXT NOT NULL,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  used BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Индексы для быстрого поиска
CREATE INDEX IF NOT EXISTS idx_verification_codes_phone ON verification_codes(phone);
CREATE INDEX IF NOT EXISTS idx_verification_codes_code ON verification_codes(code);
CREATE INDEX IF NOT EXISTS idx_verification_codes_expires_at ON verification_codes(expires_at);
```

## Как это работает

### Отправка SMS

1. Пользователь вводит номер телефона
2. Генерируется 6-значный код подтверждения
3. Код отправляется через Edge Function `send-sms-exolve` на API МТС Exolve
4. Код сохраняется в таблице `verification_codes` с временем истечения (10 минут)
5. Пользователь получает SMS с кодом

### Верификация кода

1. Пользователь вводит полученный код
2. Код проверяется в таблице `verification_codes`:
   - Совпадает ли код
   - Не истек ли срок действия
   - Не был ли уже использован
3. При успешной проверке:
   - Код помечается как использованный
   - Создается или находится пользователь в Supabase Auth
   - Номер телефона сохраняется в таблице `user_profiles`

## API Endpoint

**МТС Exolve API:**
- URL: `https://api.exolve.ru/messaging/v1/SendSMS`
- Метод: `POST`
- Авторизация: `Bearer {API_KEY}`

**Формат запроса:**
```json
{
  "number": "MTS_Link",  // Альфа-имя или номер отправителя (опционально)
  "destination": "+79001234567",  // Номер получателя в формате +7XXXXXXXXXX
  "text": "Ваш код подтверждения: 123456"  // Текст сообщения
}
```

**Формат ответа (успех):**
```json
{
  "message_id": "1234567890"  // ID сообщения для отслеживания
}
```

## Формат номера телефона

МТС Exolve требует номера в формате **E.164**: `+7XXXXXXXXXX`

Функция `normalizePhoneForSMS` автоматически преобразует:
- `8XXXXXXXXXX` → `+7XXXXXXXXXX`
- `7XXXXXXXXXX` → `+7XXXXXXXXXX`
- `XXXXXXXXXX` → `+7XXXXXXXXXX`

## Тестирование

### Тестовый режим (без подписанного договора)

**Важно:** Пока договор не подписан, действуют следующие ограничения:

1. **Ограничение на номер получателя:** SMS можно отправлять **только на свой подтверждённый номер**
   - В тестовом режиме можно отправить SMS только на номер, который вы подтвердили в личном кабинете
   - Попытки отправить SMS на другие номера могут быть отклонены

2. **Фиксированный текст сообщения:** Текст SMS автоматически заменяется на:
   > "Это тестовое SMS от МТС Exolve. Подпишите договор, чтобы изменить текст на свой"
   - Ваш код подтверждения **не будет отправлен** - текст заменяется автоматически
   - Это ограничение тестового режима

3. **Ограничения тестового аккаунта:**
   - Можно создать только 1 приложение
   - Можно купить только 1 номер
   - Можно создать до 3 SIP ID
   - Баланс: 300 ₽ (виртуальные деньги для тестирования)

4. **⚠️ Проблема с REST API в тестовом режиме:**
   - REST API может быть **недоступен или работать некорректно** в тестовом режиме
   - Веб-интерфейс работает, но программный доступ через API может быть ограничен
   - Если API не отвечает (таймаут) - это может быть связано с ограничениями тестового режима

5. **Для полноценной работы:** Необходимо подписать договор в личном кабинете МТС Exolve
   - После подписания договора можно отправлять SMS на любые номера
   - Можно использовать произвольный текст сообщений
   - Ваш код подтверждения будет доставляться корректно
   - REST API будет работать полноценно

### Проверка отправки в тестовом режиме

1. Используйте номер `+7 952 560-23-63` для тестирования
2. Откройте логи Edge Function в Supabase Dashboard:
   - Project Settings → Edge Functions → `send-sms-exolve` → Logs
3. Проверьте логи на наличие ошибок
4. Убедитесь, что SMS доставляется (но с фиксированным текстом)

**⚠️ Важно:** 
- В тестовом режиме верификация через SMS работать **не будет**, так как код подтверждения не доставляется (текст заменяется автоматически)
- REST API может быть недоступен или работать некорректно в тестовом режиме
- Если вы видите таймауты при вызове API - это может быть связано с ограничениями тестового режима
- Для полноценного тестирования необходимо подписать договор

## Ограничения тестового аккаунта (без договора)

- **Ограничение на номер получателя:** Только на свой подтверждённый номер
- **Фиксированный текст сообщения:** Автоматическая замена на тестовый текст
- **REST API может быть недоступен:** В тестовом режиме API может не работать или работать некорректно
- Можно создать только 1 приложение
- Можно купить только 1 номер
- Можно создать до 3 SIP ID
- Баланс: 300 ₽ (виртуальные деньги)

**Для снятия ограничений:** Подпишите договор в личном кабинете МТС Exolve

**Источник:** [Ограничения тестового аккаунта МТС Exolve](https://help.mts-link.ru/)

Подробнее: [Ограничения тестового аккаунта](https://docs.exolve.ru/docs/ru/instructions/)

## Устранение проблем

### Ошибка: "EXOLVE_API_KEY not configured"

**Решение:** Установите секрет через CLI:
```bash
npx supabase secrets set EXOLVE_API_KEY=ваш_ключ
npx supabase functions deploy send-sms-exolve
```

### Ошибка: "Invalid phone number format"

**Решение:** Убедитесь, что номер в формате `+7XXXXXXXXXX`. Функция нормализации должна автоматически преобразовать номер.

### Ошибка: "Unauthorized" или "Invalid API key"

**Решение:** 
1. Проверьте правильность API ключа
2. Убедитесь, что ключ активен в личном кабинете МТС Exolve
3. Проверьте, что ключ установлен правильно (без лишних пробелов)

### SMS не доставляются

**Возможные причины:**
1. Недостаточно средств на балансе МТС Exolve
2. Альфа-имя не согласовано (если используется)
3. Номер получателя заблокирован или невалиден
4. Превышен лимит отправки для тестового аккаунта

**Решение:**
1. Проверьте баланс в личном кабинете МТС Exolve
2. Проверьте статус альфа-имени
3. Попробуйте отправить на другой номер
4. Проверьте логи Edge Function для деталей ошибки

## Стоимость

- Стоимость отправки SMS зависит от тарифа МТС Exolve
- Обычно от 1-3 рублей за SMS в России
- Проверьте актуальные тарифы в личном кабинете

## Дополнительные возможности

### Отслеживание статуса доставки

МТС Exolve предоставляет webhook для отслеживания статуса доставки SMS. Можно настроить обработку событий доставки.

### Массовые рассылки

Для массовых рассылок можно использовать [Campaign API](https://docs.exolve.ru/docs/ru/api-reference/campaign-api/creating-campaign/).

### SMPP протокол

Для высоконагруженных систем (тысячи SMS в секунду) можно использовать SMPP протокол вместо REST API. Подробнее: [SMPP Documentation](https://docs.exolve.ru/docs/ru/api-reference/sms-smpp/).

## Полезные ссылки

- [Документация МТС Exolve](https://docs.exolve.ru/)
- [SMS API Reference](https://docs.exolve.ru/docs/ru/api-reference/sms-api/)
- [Инструкции по отправке SMS](https://docs.exolve.ru/docs/ru/instructions/sending-sms/)
- [Личный кабинет МТС Exolve](https://exolve.ru/)

