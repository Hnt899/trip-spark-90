# Устранение проблем с доставкой SMS

## Что было улучшено в коде

1. ✅ **Улучшена обработка форматов номеров** - код теперь автоматически очищает номера от всех нецифровых символов
2. ✅ **Добавлена детальная диагностика ошибок** - в логах теперь видно полную информацию об ошибках от API
3. ✅ **Улучшено логирование** - больше информации о том, какие данные отправляются в API

## Проверка настроек номера в МТС Exolve

Поскольку номер куплен специально для отправки SMS, нужно проверить настройки:

### 1. Проверка привязки номера к приложению

1. Личный кабинет МТС Exolve → **"Приложения"**
2. Выберите ваше приложение
3. Проверьте, привязан ли номер `+7 992 669-08-70` к приложению
4. Если нет - привяжите номер к приложению

### 2. Проверка настроек номера

1. Личный кабинет МТС Exolve → **"Нумерация"** → **"Мои номера"**
2. Найдите номер `+7 992 669-08-70`
3. Проверьте:
   - ✅ Статус номера (должен быть "Активен")
   - ✅ Разрешения на отправку SMS (должно быть включено)
   - ✅ Привязка к приложению
   - ✅ Настройки отправителя

### 3. Проверка прав приложения

1. Личный кабинет МТС Exolve → **"Приложения"**
2. Выберите ваше приложение
3. Проверьте права:
   - ✅ Отправка SMS
   - ✅ Использование номера для отправки

### 4. Проверка API ключа

Убедитесь, что API ключ:
- ✅ Создан для правильного приложения
- ✅ Имеет права на отправку SMS
- ✅ Активен (не отозван)

## Возможные причины "Неуспешно"

### 1. Номер не привязан к приложению
**Решение:** Привяжите номер к приложению в личном кабинете

### 2. Номер не активирован для отправки SMS
**Решение:** Активируйте отправку SMS для номера в настройках

### 3. Недостаточно прав у API ключа
**Решение:** Проверьте права API ключа, создайте новый если нужно

### 4. Неправильный формат номера
**Решение:** Код теперь автоматически очищает номера, но проверьте логи

### 5. Номер заблокирован или ограничен
**Решение:** Проверьте статус номера в личном кабинете, свяжитесь с поддержкой

## Что проверить в логах

После отправки SMS проверьте логи Edge Function:

1. **Успешный запрос к API:**
   - `Response status: 200`
   - `message_id` получен

2. **Формат номеров:**
   - `Final destination (for API):` - должен быть `7XXXXXXXXXX` (11 цифр)
   - `Sender (for API):` - должен быть `79926690870` (11 цифр)

3. **Ошибки (если есть):**
   - `МТС Exolve API Error` - детальная информация об ошибке
   - `Error details:` - дополнительные детали

## Связь с поддержкой МТС Exolve

Если после проверки всех настроек SMS все еще не доставляются:

1. **Соберите информацию:**
   - `message_id` из логов (например: `593001091847686706`)
   - Номер отправителя: `+7 992 669-08-70`
   - Номер получателя (тестовый)
   - Скриншот истории сообщений со статусом "Неуспешно"

2. **Обратитесь в поддержку:**
   - Телефон: 8 800 505-72-98
   - Чат в личном кабинете
   - Email через личный кабинет

3. **Спросите:**
   - Почему номер не доставляет SMS (статус "Неуспешно")
   - Нужно ли что-то настроить дополнительно
   - Правильно ли номер привязан к приложению
   - Есть ли ограничения на отправку с этого номера

## Временное решение для тестирования

Пока проблема не решена, можно:

1. **Попробовать без указания номера отправителя:**
   ```bash
   npx supabase secrets unset EXOLVE_SENDER
   npx supabase functions deploy send-sms-exolve
   ```
   Это заставит МТС Exolve использовать номер по умолчанию из аккаунта.

2. **Проверить другой номер получателя:**
   - Попробуйте отправить на другой номер
   - Возможно, проблема с конкретным номером получателя

3. **Проверить через веб-интерфейс:**
   - Отправьте SMS через веб-интерфейс МТС Exolve
   - Если работает - проблема в API запросе
   - Если не работает - проблема в настройках номера

## Следующие шаги

1. ✅ Код обновлен и улучшен
2. ⏳ Проверьте настройки номера в личном кабинете
3. ⏳ Попробуйте отправить SMS снова
4. ⏳ Проверьте логи на наличие ошибок
5. ⏳ Если не работает - свяжитесь с поддержкой МТС Exolve

