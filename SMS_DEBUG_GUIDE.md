# Отладка отправки SMS

## Важно о ошибках в IDE

Ошибки линтера в IDE (красные подчеркивания) - это **нормально** для Deno Edge Functions. TypeScript в IDE не знает о типах Deno, но в Deno runtime все работает правильно.

## Что делать, если SMS не приходит

### Шаг 1: Передеплойте функцию с логированием

```powershell
npx supabase functions deploy send-sms-otp-smsc
```

### Шаг 2: Проверьте логи Edge Function

1. Откройте Supabase Dashboard
2. В левом меню найдите **Logs & Analytics** (или **Logs**)
3. В разделе **COLLECTIONS** нажмите на **Edge Functions** (иконка с молнией)
4. Вы увидите логи всех Edge Functions
5. Найдите записи для функции `send-sms-otp-smsc`
6. Попробуйте отправить SMS через приложение
7. Обновите страницу с логами - должны появиться новые записи

**Важно:** Если в Edge Functions нет логов, проверьте **Auth** логи (в том же разделе COLLECTIONS) - возможно, Hook не вызывается.

**Что искать в логах:**
- `=== SMS Hook Called ===` - функция вызвана
- `Request body:` - данные, которые получила функция
- `Extracted phone:` - номер телефона
- `Extracted message:` - сообщение
- `SMSC.ru response:` - ответ от SMSC.ru
- `=== SMS Hook Error ===` - если есть ошибка

### Шаг 3: Проверьте, что Hook настроен правильно

1. **Project Settings** → **Auth** → **Hooks**
2. Убедитесь, что **Send SMS Hook** включен
3. Проверьте URL: `https://fwjwqtwwsxchjlgwrmdj.supabase.co/functions/v1/send-sms-otp-smsc`
4. Убедитесь, что секрет установлен

### Шаг 4: Проверьте секреты

```powershell
# Проверьте, что секреты установлены
npx supabase secrets list
```

Должны быть:
- `SMSC_LOGIN` - ваш логин SMSC.ru
- `SMSC_PASSWORD` - ваш пароль SMSC.ru
- `SMS_HOOK_SECRET` - секрет для Hook (опционально)

### Шаг 5: Проверьте формат номера телефона

Supabase отправляет номер в формате E.164 (например: `+79525602363`).

Если в логах видите другой формат, проверьте:
- Нормализуется ли номер в `AuthContext.tsx`
- Правильно ли сохраняется номер в профиле

### Шаг 6: Проверьте баланс SMSC.ru

1. Войдите в личный кабинет SMSC.ru
2. Проверьте баланс
3. Убедитесь, что есть средства для отправки SMS

### Шаг 7: Проверьте настройки Hook в Dashboard

В логах Edge Function проверьте:
- Приходит ли запрос от Supabase
- Правильно ли парсятся данные (phone, message)
- Что возвращает SMSC.ru API

## Частые проблемы

### Проблема: "Missing phone or message"

**Причина:** Supabase отправляет данные в другом формате

**Решение:** В логах посмотрите `Request body:` и проверьте, какие поля приходят. Обновите код для извлечения phone и message.

### Проблема: "SMSC credentials not configured"

**Причина:** Секреты не установлены или установлены неправильно

**Решение:**
```powershell
npx supabase secrets set SMSC_LOGIN=ваш_логин
npx supabase secrets set SMSC_PASSWORD=ваш_пароль
npx supabase functions deploy send-sms-otp-smsc
```

### Проблема: "Unauthorized"

**Причина:** Секрет Hook не совпадает

**Решение:** 
1. В Dashboard сгенерируйте новый секрет
2. Установите его: `npx supabase secrets set SMS_HOOK_SECRET=новый_секрет`
3. Или временно отключите проверку секрета в коде

### Проблема: SMSC.ru возвращает ошибку

**Причина:** Проблемы с API SMSC.ru

**Решение:** 
1. Проверьте логи - там будет код ошибки SMSC.ru
2. Проверьте баланс
3. Проверьте правильность логина и пароля
4. Проверьте формат номера телефона

## Тестирование

После исправления:

1. Передеплойте функцию
2. Попробуйте отправить SMS через приложение
3. Проверьте логи в реальном времени
4. Если есть ошибки - скопируйте их и проверьте по этой инструкции

