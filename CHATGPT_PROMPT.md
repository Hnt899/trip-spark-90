# Промпт для ChatGPT - Проблема с доставкой SMS через МТС Exolve API

## Ситуация

Я разрабатываю веб-приложение с авторизацией через SMS. Использую МТС Exolve для отправки SMS-кодов подтверждения через их REST API. 

**Проблема:** SMS успешно отправляются через API (получаем `message_id` и HTTP 200), но в истории сообщений МТС Exolve статус доставки показывает "Неуспешно" (Unsuccessful). При этом, если отправлять SMS через веб-интерфейс МТС Exolve с теми же данными - SMS доставляются успешно (статус "Доставлено").

## Технические детали

### Используемый стек:
- **Frontend:** React + TypeScript
- **Backend:** Supabase Edge Functions (Deno runtime)
- **SMS Provider:** МТС Exolve REST API
- **Endpoint:** `https://api.exolve.ru/messaging/v1/SendSMS`

### Текущая реализация:

**Edge Function (Supabase):**
```typescript
const apiUrl = 'https://api.exolve.ru/messaging/v1/SendSMS'

// Формируем тело запроса
const requestBody = {
  number: "79926690870",      // Номер отправителя (только цифры, без +)
  destination: "79525602363",  // Номер получателя (только цифры, без +)
  text: "Ваш код подтверждения: 123456"
}

const response = await fetch(apiUrl, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${apiKey}`,  // JWT токен из личного кабинета
    'Accept': 'application/json'
  },
  body: JSON.stringify(requestBody)
})
```

**Формат запроса:**
- Номера в формате только цифр: `79926690870`, `79525602363` (без `+`, без пробелов, без дефисов)
- Поле `number` - номер отправителя (опционально, но указываем)
- Поле `destination` - номер получателя (обязательно)
- Поле `text` - текст сообщения

### Что работает:

✅ **API запросы успешны:**
- Edge Function вызывается корректно
- МТС Exolve API отвечает HTTP 200 OK
- Получаем `message_id` в ответе (например: `593004690929617583`)
- Коды сохраняются в базу данных

✅ **Веб-интерфейс работает:**
- Отправка SMS через веб-интерфейс МТС Exolve доставляет SMS успешно
- Используем те же данные: отправитель `+7 992 669-08-70`, получатель `+7 952 560-23-63`
- В истории сообщений статус "Доставлено" (зеленый)

### Что не работает:

❌ **API запросы не доставляют SMS:**
- При отправке через API получаем `message_id`, но статус доставки "Неуспешно" (оранжевый)
- SMS не приходят на телефон получателя
- В истории сообщений видно, что сообщения отправлены, но не доставлены

### История сообщений в МТС Exolve:

**Успешные (через веб-интерфейс):**
- ID: `593004690929617583`
- Отправитель: `+7 992 669-08-70`
- Получатель: `+7 952 560-23-63`
- Статус: **"Доставлено"** ✅
- Категория: "С моб.номера"

**Неуспешные (через API):**
- ID: `593004366458260018`, `593002169481824943`, и др.
- Отправитель: `+7 992 669-08-70` (тот же)
- Получатель: `+7 952 560-23-63` или `+7 950 865-86-98`
- Статус: **"Неуспешно"** ❌
- Категория: "С моб.номера"

### Сравнение запросов:

**Веб-интерфейс (работает):**
```json
{
  "number": "79926690870",
  "destination": "79525602363",
  "text": "Тестовое SMS от MTC Exolve"
}
```

**API запрос (не доставляет):**
```json
{
  "number": "79926690870",
  "destination": "79525602363",
  "text": "Ваш код подтверждения: 123456"
}
```

Формат запросов идентичен, но результаты разные.

### Настройки аккаунта:

- ✅ Номер отправителя `+7 992 669-08-70` куплен в МТС Exolve специально для отправки SMS
- ✅ Номер активен и настроен
- ✅ API ключ (JWT токен) получен из личного кабинета
- ✅ API ключ имеет права на отправку SMS
- ✅ Баланс достаточен для отправки

### Логи Edge Function:

```
=== МТС Exolve SMS Sending ===
Request method: POST
EXOLVE_API_KEY configured: true
EXOLVE_API_KEY length: 1809
EXOLVE_SENDER configured: +79926690870
Original destination phone: +79525602363
Normalized phone (digits only): 79525602363
Sending SMS to МТС Exolve...
Endpoint: https://api.exolve.ru/messaging/v1/SendSMS
Sender (for API): 79926690870
Final destination (for API): 79525602363
Request body: {
  "number": "79926690870",
  "destination": "79525602363",
  "text": "Ваш код подтверждения: 123456"
}
Fetch completed in 385ms
Response status: 200
Response ok: true
МТС Exolve response text: {"message_id":"593004690929617583"}
SMS sent successfully!
Message ID: 593004690929617583
```

## Вопросы

1. **Почему API запросы не доставляют SMS, хотя веб-интерфейс работает?**
   - Формат запросов идентичен
   - API отвечает успешно (HTTP 200, `message_id`)
   - Но статус доставки "Неуспешно"

2. **Что может быть не так в API запросе?**
   - Может быть нужны дополнительные заголовки?
   - Может быть нужны дополнительные параметры в теле запроса?
   - Может быть проблема с авторизацией (хотя API отвечает успешно)?

3. **Есть ли различия между веб-интерфейсом и API?**
   - Веб-интерфейс использует тот же endpoint?
   - Может быть веб-интерфейс добавляет что-то дополнительно?

4. **Что проверить в настройках МТС Exolve?**
   - Может быть нужна дополнительная настройка для API?
   - Может быть номер нужно привязать к приложению по-другому?

5. **Есть ли известные проблемы с доставкой SMS через API МТС Exolve?**
   - Может быть это известная проблема?
   - Может быть есть ограничения для API запросов?

## Документация МТС Exolve

- [Как отправить SMS](https://docs.exolve.ru/docs/ru/instructions/sending-sms/)
- [SMS API Reference](https://docs.exolve.ru/docs/ru/api-reference/sms-api/)

## Что уже пробовали

1. ✅ Проверили формат номеров (только цифры, без `+`)
2. ✅ Проверили формат запроса (точно как в веб-интерфейсе)
3. ✅ Проверили авторизацию (API отвечает успешно)
4. ✅ Проверили настройки номера (номер активен, куплен для SMS)
5. ✅ Проверили права API ключа (права на отправку SMS есть)
6. ✅ Сравнили запросы веб-интерфейса и API (формат идентичен)

## Нужна помощь

Помогите разобраться, почему API запросы не доставляют SMS, хотя:
- API отвечает успешно (HTTP 200, `message_id`)
- Формат запроса идентичен веб-интерфейсу
- Веб-интерфейс работает и доставляет SMS
- Настройки аккаунта корректны

Что может быть причиной и как это исправить?

