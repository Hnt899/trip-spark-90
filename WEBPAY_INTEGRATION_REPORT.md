# –û—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç—É –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ WebPay

## üìã –ó–∞–¥–∞—á–∞ 1 ‚Äî "–ö–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞"

### –°—Ç–µ–∫ –∏ —Ä–∞–Ω—Ç–∞–π–º

**–§—Ä–æ–Ω—Ç–µ–Ω–¥:**
- **–§—Ä–µ–π–º–≤–æ—Ä–∫:** React 18.3.1 + TypeScript 5.8.3
- **–°–±–æ—Ä—â–∏–∫:** Vite 5.4.19
- **–†–æ—É—Ç–∏–Ω–≥:** React Router DOM 6.30.1
- **–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞:** `src/main.tsx` ‚Üí `src/App.tsx`
- **UI –±–∏–±–ª–∏–æ—Ç–µ–∫–∞:** shadcn-ui + Radix UI + Tailwind CSS
- **State management:** React Context (AuthContext) + TanStack Query

**–ë—ç–∫–µ–Ω–¥:**
- **–û—Å–Ω–æ–≤–Ω–æ–π –±—ç–∫–µ–Ω–¥:** Supabase (PostgreSQL + Edge Functions)
- **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä:** Express.js (Node.js) ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è AI-—á–∞—Ç–∞ (`server/index.js`)
- **Edge Functions:** Supabase Edge Functions (Deno runtime)
  - `supabase/functions/send-sms-exolve/` ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ SMS
  - `supabase/functions/verify-2fa-token/` ‚Äî –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è 2FA

**–î–µ–ø–ª–æ–π:**
- **Frontend:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Netlify (`netlify.toml`) –∏ Vercel (`vercel.json`)
- **Backend:** Supabase Cloud (Edge Functions)
- **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä:** –õ–æ–∫–∞–ª—å–Ω—ã–π Express –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ö–æ—Å—Ç–∏–Ω–≥ (–¥–ª—è AI-—á–∞—Ç–∞)

### –ì–¥–µ –∏ –∫–∞–∫ —Å–æ–∑–¥–∞—ë—Ç—Å—è "–∑–∞–∫–∞–∑/–ø–æ–∫—É–ø–∫–∞"

**–°—É—â–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞:**

1. **–¢–∞–±–ª–∏—Ü–∞ `tickets`** (–æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–∫–∞–∑–æ–≤):
   - –§–∞–π–ª: `supabase/migrations/20241215000000_add_tickets_table.sql`
   - –ü–æ–ª—è:
     - `id` (UUID, PK)
     - `user_id` (UUID, FK ‚Üí auth.users)
     - `order_number` (TEXT, NOT NULL) ‚Äî –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
     - `transport_type` (TEXT: 'train' | 'flight' | 'bus')
     - `total_price` (DECIMAL(10, 2))
     - `tickets_data` (JSONB) ‚Äî –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤ (EpdData[])
     - `from_city`, `to_city`, `departure_date`
     - `electronic_registration_status` ('pending' | 'confirmed')
     - `order_status` ('active' | 'refunded' | 'exchanged') ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ `20241220000000_add_order_status_to_tickets.sql`
     - `created_at`, `updated_at`

2. **–¢–∞–±–ª–∏—Ü–∞ `orders`** (–∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∞, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è):
   - –§–∞–π–ª: `supabase-schema.sql` (—Å—Ç—Ä–æ–∫–∏ 81-89)
   - –ü–æ–ª—è: `id`, `user_id`, `order_number`, `status`, `total_amount`
   - **–°—Ç–∞—Ç—É—Å:** –¢–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –≤ –∫–æ–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–ì–¥–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å—É–º–º–∞, –≤–∞–ª—é—Ç–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ø–æ–∑–∏—Ü–∏–∏:**

- **–§–∞–π–ª:** `src/pages/Checkout.tsx`
- **–°—Ç—Ä–æ–∫–∏:** 610-620
- **–õ–æ–≥–∏–∫–∞:**
  ```typescript
  const basePrice = parseInt(price) * adults + (parseInt(price) * 0.7 * children);
  const additionalServicesPrice = 
    (additionalServices.insurance === "yes" ? 299 : 0) +
    (additionalServices.refund === "yes" ? 550 : 0);
  const certificateDiscount = selectedCertificate?.amount || 0;
  const totalPrice = Math.max(0, basePrice + additionalServicesPrice - certificateDiscount);
  ```
- **–í–∞–ª—é—Ç–∞:** –ñ—ë—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∞ –∫–∞–∫ ‚ÇΩ (—Ä—É–±–ª–∏), —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `toLocaleString("ru-RU")`
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:** –ò–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (`adults`, `children`, `infants`)
- **–ü–æ–∑–∏—Ü–∏–∏:** –•—Ä–∞–Ω—è—Ç—Å—è –≤ `tickets_data` (JSONB) –∫–∞–∫ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ `EpdData`

**–ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è order_id / –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:**

- **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞:**
  - –§–∞–π–ª: `src/pages/Checkout.tsx`
  - –°—Ç—Ä–æ–∫–∏: 443-444
  - –§–æ—Ä–º–∞—Ç: `T{timestamp}` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `T1234567890`)
  - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Å—Å–∞–∂–∏—Ä–∞: `${baseOrderNumber}${i}` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `T12345678900`, `T12345678901`)
  
- **–•—Ä–∞–Ω–µ–Ω–∏–µ:**
  - –í –ë–î: `tickets.order_number` (TEXT)
  - –í PDF –±–∏–ª–µ—Ç–µ: –ø–æ–ª–µ `orderNumber` –≤ `EpdData`
  - –ò–Ω–¥–µ–∫—Å: `idx_tickets_order_number` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

### –ö–∞–∫ —Å–µ–π—á–∞—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è "—É—Å–ø–µ—Ö –æ–ø–ª–∞—Ç—ã"

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–∑–∞–≥–ª—É—à–∫–∞):**

- **–§–∞–π–ª:** `src/pages/Checkout.tsx`
- **–§—É–Ω–∫—Ü–∏—è:** `handlePay()` (—Å—Ç—Ä–æ–∫–∏ 404-604)
- **–õ–æ–≥–∏–∫–∞:**
  1. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
  2. `setIsProcessing(true)` ‚Üí —Å–∏–º—É–ª—è—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ 2 —Å–µ–∫—É–Ω–¥—ã
  3. `setIsCompleted(true)` ‚Üí –ø–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ —É—Å–ø–µ—Ö–∞
  4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –±–∏–ª–µ—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤
  5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ PDF
  6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î (`tickets` —Ç–∞–±–ª–∏—Ü–∞)
  7. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã

**–°—Ç—Ä–∞–Ω–∏—Ü—ã success/cancel:**

- ‚ùå **–ù–ï –ù–ê–ô–î–ï–ù–û** ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü `/payment/success` –∏–ª–∏ `/payment/cancel` –Ω–µ—Ç
- ‚úÖ –ï—Å—Ç—å —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —ç–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞ –≤ `Checkout.tsx` (—Å—Ç—Ä–æ–∫–∏ 668-687)

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã:**

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–ª–µ—Ç–æ–≤:** `generateRzdStyleTicket()` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Å—Å–∞–∂–∏—Ä–∞
2. **–°–∫–∞—á–∏–≤–∞–Ω–∏–µ PDF:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `<a download>`
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î:** INSERT –≤ `tickets` —Å `electronic_registration_status: 'pending'`
4. **–†–µ–¥–∏—Ä–µ–∫—Ç:** `navigate("/")` —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
5. **–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç:** –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω, –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `status: 'used'` –≤ —Ç–∞–±–ª–∏—Ü–µ `certificates`

---

## üìç –ó–∞–¥–∞—á–∞ 2 ‚Äî –¢–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ WebPay

| –ß—Ç–æ | –ì–¥–µ | –§–∞–π–ª | –§—É–Ω–∫—Ü–∏—è/–ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç—Ä–æ–∫–∏ |
|-----|-----|------|-------------------|--------|
| **–ö–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏—Ç—å"** | –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ | `src/pages/Checkout.tsx` | `Button` —Å `onClick={handlePay}` | 782-800 |
| **–ú–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞** | –ü–µ—Ä–µ–¥ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º –Ω–∞ –æ–ø–ª–∞—Ç—É | `src/pages/Checkout.tsx` | `handlePay()` | 404-604 |
| **–†–∞—Å—á—ë—Ç —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞** | –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ Checkout | `src/pages/Checkout.tsx` | `totalPrice` (computed) | 610-620 |
| **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è order_number** | –í handlePay –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º | `src/pages/Checkout.tsx` | `baseOrderNumber = T{timestamp}` | 443-444 |
| **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ –ë–î** | –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã (—Å–µ–π—á–∞—Å —Å–∏–º—É–ª—è—Ü–∏—è) | `src/pages/Checkout.tsx` | `supabase.from("tickets").insert()` | 574-593 |
| **–†–µ–¥–∏—Ä–µ–∫—Ç –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã** | –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ | `src/pages/Checkout.tsx` | `navigate("/")` | 601 |
| **–ú–µ—Å—Ç–æ –¥–ª—è wsb_notify_url** | ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ | ‚Äî | **–ù–£–ñ–ù–û –°–û–ó–î–ê–¢–¨:** Supabase Edge Function | ‚Äî |
| **–ú–µ—Å—Ç–æ –¥–ª—è return_url** | ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ | ‚Äî | **–ù–£–ñ–ù–û –°–û–ó–î–ê–¢–¨:** `/payment/success` —Å—Ç—Ä–∞–Ω–∏—Ü–∞ | ‚Äî |
| **–ú–µ—Å—Ç–æ –¥–ª—è cancel_return_url** | ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ | ‚Äî | **–ù–£–ñ–ù–û –°–û–ó–î–ê–¢–¨:** `/payment/cancel` —Å—Ç—Ä–∞–Ω–∏—Ü–∞ | ‚Äî |

**–î–µ—Ç–∞–ª–∏:**

1. **–ö–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏—Ç—å":**
   - –¢–µ–∫—Å—Ç: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" (—Å—Ç—Ä–æ–∫–∞ 798)
   - –£—Å–ª–æ–≤–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: `!isProcessing && additionalServices.insurance && additionalServices.refund && consentChecked`
   - –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ checkout (–ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥)

2. **–ú–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:**
   - –°–µ–π—á–∞—Å –∑–∞–∫–∞–∑ —Å–æ–∑–¥–∞—ë—Ç—Å—è **–ø–æ—Å–ª–µ** —Å–∏–º—É–ª—è—Ü–∏–∏ –æ–ø–ª–∞—Ç—ã (—Å—Ç—Ä–æ–∫–∞ 574)
   - **–ù–£–ñ–ù–û –ò–ó–ú–ï–ù–ò–¢–¨:** –°–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–∫–∞–∑ **–¥–æ** —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ WebPay, —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`

3. **–ì–¥–µ –ª–æ–≥–∏—á–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å wsb_notify_url:**
   - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å Supabase Edge Function
   - –ü—É—Ç—å: `supabase/functions/webpay-notify/index.ts`
   - Endpoint: `https://{project}.supabase.co/functions/v1/webpay-notify`
   - –õ–æ–≥–∏–∫–∞: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ –≤ `tickets`, –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

4. **–ì–¥–µ –ª–æ–≥–∏—á–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å return_url / cancel_return_url:**
   - **Success:** –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É `/payment/success` (React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
   - **Cancel:** –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É `/payment/cancel` (React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
   - –î–æ–±–∞–≤–∏—Ç—å —Ä–æ—É—Ç—ã –≤ `src/App.tsx`

---

## üîê –ó–∞–¥–∞—á–∞ 3 ‚Äî –û–∫—Ä—É–∂–µ–Ω–∏–µ –∏ —Å–µ–∫—Ä–µ—Ç—ã

### –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

**Frontend (Vite):**
- –§–∞–π–ª: `.env.local` (–Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω)
- –ü—Ä–µ—Ñ–∏–∫—Å: `VITE_` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è Vite)
- –¢–µ–∫—É—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
  - `VITE_SUPABASE_URL` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `src/lib/supabase.ts:3`
  - `VITE_SUPABASE_ANON_KEY` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `src/lib/supabase.ts:4`
- –î–æ—Å—Ç—É–ø: `import.meta.env.VITE_*`

**Backend (Express):**
- –§–∞–π–ª: `.env` (–≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞)
- –¢–µ–∫—É—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
  - `HF_API_TOKEN` ‚Äî –¥–ª—è AI-—á–∞—Ç–∞
  - `HF_MODEL` ‚Äî –º–æ–¥–µ–ª—å –¥–ª—è AI
  - `PORT` ‚Äî –ø–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 4000)

**Supabase Edge Functions:**
- –•—Ä–∞–Ω–µ–Ω–∏–µ: Supabase Dashboard ‚Üí Project Settings ‚Üí Edge Functions ‚Üí Secrets
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞: `npx supabase secrets set KEY=value`
- –¢–µ–∫—É—â–∏–µ —Å–µ–∫—Ä–µ—Ç—ã:
  - `EXOLVE_API_KEY` ‚Äî –¥–ª—è SMS
  - `EXOLVE_SENDER` ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å SMS
  - `SUPABASE_URL` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
  - `SUPABASE_SERVICE_ROLE_KEY` ‚Äî –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### –ï—Å—Ç—å –ª–∏ —É–∂–µ –∫–ª—é—á–∏ –ø–ª–∞—Ç–µ–∂–µ–π

- ‚ùå **–ù–ï –ù–ê–ô–î–ï–ù–û** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –Ω–µ—Ç
- ‚úÖ –ï—Å—Ç—å —Ç–æ–ª—å–∫–æ —Å–∏–º—É–ª—è—Ü–∏—è –æ–ø–ª–∞—Ç—ã –≤ `Checkout.tsx`

### –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å WebPay –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

**–î–ª—è Frontend (Vite):**
```env
# .env.local
VITE_WEBPAY_STORE_ID=your_store_id
VITE_WEBPAY_TEST_MODE=true
VITE_WEBPAY_BASE_URL=https://securesandbox.webpay.by
```

**–î–ª—è Supabase Edge Functions (notify endpoint):**
```bash
npx supabase secrets set WEBPAY_STORE_ID=your_store_id
npx supabase secrets set WEBPAY_SECRET_KEY=your_secret_key
npx supabase secrets set WEBPAY_TEST_MODE=true
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** `WEBPAY_SECRET_KEY` –ù–ï –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ frontend! –¢–æ–ª—å–∫–æ –≤ Edge Function –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏.

### –î–æ–º–µ–Ω—ã/URL –ø—Ä–æ–µ–∫—Ç–∞

- ‚ùå **–ù–ï –ù–ê–ô–î–ï–ù–û** ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã –≤ –∫–æ–¥–µ
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è URL:**
  - **Dev:** `http://localhost:8080` (Vite dev server)
  - **Production:** –ù—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å —É –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–æ–µ–∫—Ç–∞
  - **Supabase Edge Functions:** `https://{project-id}.supabase.co/functions/v1/webpay-notify`

**–§–æ—Ä–º–∞—Ç return/cancel/notify URL:**
- `return_url`: `https://yourdomain.com/payment/success?order_id={order_id}`
- `cancel_return_url`: `https://yourdomain.com/payment/cancel?order_id={order_id}`
- `wsb_notify_url`: `https://{project-id}.supabase.co/functions/v1/webpay-notify`

---

## ‚úÖ –ó–∞–¥–∞—á–∞ 4 ‚Äî –ß–µ–∫–ª–∏—Å—Ç –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å

1. **WEBPAY_STORE_ID** (sandbox)
   - –§–æ—Ä–º–∞—Ç: —á–∏—Å–ª–æ –∏–ª–∏ —Å—Ç—Ä–æ–∫–∞
   - –ì–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: Frontend (–¥–ª—è —Ñ–æ—Ä–º—ã) + Edge Function (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)

2. **WEBPAY_SECRET_KEY** (sandbox)
   - –§–æ—Ä–º–∞—Ç: —Å—Ç—Ä–æ–∫–∞ (—Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á)
   - ‚ö†Ô∏è **–¢–û–õ–¨–ö–û –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏** (Supabase Edge Function)
   - –ù–ï –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –≤ frontend –∫–æ–¥

3. **currency_id**
   - –§–æ—Ä–º–∞—Ç: —á–∏—Å–ª–æ (–æ–±—ã—á–Ω–æ 933 –¥–ª—è BYN, 974 –¥–ª—è BYR, 840 –¥–ª—è USD, 978 –¥–ª—è EUR)
   - –ù—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å: –∫–∞–∫–∞—è –≤–∞–ª—é—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è? (—Å–µ–π—á–∞—Å –≤ –∫–æ–¥–µ ‚ÇΩ ‚Äî —Ä—É–±–ª–∏)

4. **–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏**
   - –û–±—ã—á–Ω–æ: `payment` (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞)
   - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: `recurring`, `preauth` –∏ —Ç.–¥.
   - –ù—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å: `payment`?

5. **return_url / cancel_return_url / wsb_notify_url**
   - **return_url:** `https://yourdomain.com/payment/success`
   - **cancel_return_url:** `https://yourdomain.com/payment/cancel`
   - **wsb_notify_url:** `https://{supabase-project}.supabase.co/functions/v1/webpay-notify`
   - ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å: –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–æ–º–µ–Ω—ã –¥–ª—è dev/stage/prod

6. **–§–æ—Ä–º–∞—Ç order_num**
   - –¢–µ–∫—É—â–∏–π —Ñ–æ—Ä–º–∞—Ç: `T{timestamp}` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `T1234567890`)
   - –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è WebPay: –æ–±—ã—á–Ω–æ –¥–æ 30 —Å–∏–º–≤–æ–ª–æ–≤, —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞ –∏ —Ü–∏—Ñ—Ä—ã
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ñ–æ—Ä–º–∞—Ç –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ `ORDER-{timestamp}-{random}`?

7. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:**
   - –î–æ–º–µ–Ω production —Å–∞–π—Ç–∞
   - –î–æ–º–µ–Ω Supabase –ø—Ä–æ–µ–∫—Ç–∞ (–¥–ª—è notify URL)
   - –ù—É–∂–Ω–∞ –ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —á–∞—Å—Ç–∏—á–Ω–æ–π –æ–ø–ª–∞—Ç—ã?
   - –ù—É–∂–Ω–∞ –ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π?

---

## üöÄ –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –°–æ–∑–¥–∞—Ç—å `.env.local` —Å `VITE_WEBPAY_*` –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ Supabase: `WEBPAY_STORE_ID`, `WEBPAY_SECRET_KEY`, `WEBPAY_TEST_MODE`
- [ ] –ü–æ–ª—É—á–∏—Ç—å –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞: store_id, secret_key, currency_id, –¥–æ–º–µ–Ω—ã

### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ endpoint –¥–ª—è notify
- [ ] –°–æ–∑–¥–∞—Ç—å `supabase/functions/webpay-notify/index.ts`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏ WebPay
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ –≤ `tickets` —Ç–∞–±–ª–∏—Ü–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å endpoint –ª–æ–∫–∞–ª—å–Ω–æ

### –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü success/cancel
- [ ] –°–æ–∑–¥–∞—Ç—å `src/pages/PaymentSuccess.tsx`
- [ ] –°–æ–∑–¥–∞—Ç—å `src/pages/PaymentCancel.tsx`
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ä–æ—É—Ç—ã –≤ `src/App.tsx`: `/payment/success`, `/payment/cancel`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ

### –®–∞–≥ 4: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è Checkout.tsx
- [ ] –ò–∑–º–µ–Ω–∏—Ç—å `handlePay()`: —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–∫–∞–∑ **–¥–æ** —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ WebPay
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞: `payment_status: 'pending'` –≤ `tickets`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è WebPay (wsb_* –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ WebPay (POST —Ñ–æ—Ä–º–∞ –∏–ª–∏ fetch)
- [ ] –£–±—Ä–∞—Ç—å —Å–∏–º—É–ª—è—Ü–∏—é –æ–ø–ª–∞—Ç—ã

### –®–∞–≥ 5: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –≤ –ë–î (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω—ã –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ `tickets`:
  - `payment_status` ('pending' | 'paid' | 'failed' | 'cancelled')
  - `payment_id` (ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç WebPay)
  - `payment_date` (–¥–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã)
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

### –®–∞–≥ 6: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è WebPay —Ñ–æ—Ä–º—ã
- [ ] –°–æ–∑–¥–∞—Ç—å —É—Ç–∏–ª–∏—Ç—É –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏ WebPay (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –Ω–∞ WebPay
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ç–≤–µ—Ç–∞ –æ—Ç WebPay (success/cancel)

### –®–∞–≥ 7: –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
- [ ] –í `PaymentSuccess.tsx`: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
- [ ] –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ notify: –ø–æ–∫–∞–∑–∞—Ç—å –±–∏–ª–µ—Ç—ã, —Å–∫–∞—á–∞—Ç—å PDF
- [ ] –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –µ—â—ë –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞: –ø–æ–∫–∞–∑–∞—Ç—å "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"

### –®–∞–≥ 8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª: —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç ‚Üí –æ–ø–ª–∞—Ç–∞ ‚Üí success
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–º–µ–Ω—É –æ–ø–ª–∞—Ç—ã ‚Üí cancel —Å—Ç—Ä–∞–Ω–∏—Ü–∞
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å notify endpoint (–º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ curl/Postman)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ –≤ –ë–î
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å edge cases (–¥—É–±–ª–∏–∫–∞—Ç—ã notify, —Ç–∞–π–º–∞—É—Ç—ã –∏ —Ç.–¥.)

---

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–í–∞–ª—é—Ç–∞:** –í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚ÇΩ (—Ä—É–±–ª–∏), –Ω–æ WebPay —Ä–∞–±–æ—Ç–∞–µ—Ç —Å BYN. –ù—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –≤–∞–ª—é—Ç—É –ø—Ä–æ–µ–∫—Ç–∞.

2. **–¢–∞–±–ª–∏—Ü–∞ orders:** –°—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å—Ö–µ–º–µ, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞ –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç –±–∏–ª–µ—Ç–æ–≤.

3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** 
   - –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á WebPay –ù–ï –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –≤ frontend
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –¥–ª—è –≤—Å–µ—Ö URL

4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.

5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** –ù—É–∂–Ω–æ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞:
   - WebPay –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
   - Notify –Ω–µ –ø—Ä–∏—à—ë–ª
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–æ –≤—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞:** 2025-01-27  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã

